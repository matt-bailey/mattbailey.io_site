<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
    <head>
    <link href="http://gmpg.org/xfn/11" rel="profile">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

    <title>
    
        Optimising the Critical Rendering Path, and Loading CSS Asynchronously and Conditionally &middot; Matt Bailey
    
    </title>

    <link rel="stylesheet" href="/css/main.css">

    <script src="//use.typekit.net/vbu2ffi.js"></script>
    <script>try{Typekit.load();}catch(e){}</script>

    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="icon" type="image/png" href="/favicon-196x196.png" sizes="196x196">
    <link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <meta name="msapplication-TileColor" content="#2b5797">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">

    <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>

    <body class="optimising-the-critical-rendering-path,-and-loading-css-asynchronously-and-conditionally layout-reverse">
        <!--[if lt IE 9]>
<div class="outdated-browser message message--alert">You are using an outdated browser. Please <a href="http://outdatedbrowser.com/en">upgrade</a> to improve your experience.</div>
<![endif]-->

        <input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">
<div class="sidebar" id="sidebar">
    <div class="sidebar-item sidebar-item--desc">
        <p>Matt is a frontend designer &amp; developer, based in London.</p>
    </div>
    <nav class="sidebar-nav">
        <a class="sidebar-nav-item" href="/">Home</a>
        
        
        
        
        
        
        
        
        <a class="sidebar-nav-item" href="/about-me/">About Me</a>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    </nav>
    <div class="sidebar-item">
        <p>You can also find Matt on <a href="https://twitter.com/_mattbailey">Twitter</a>, <a href="https://dribbble.com/mattbailey">Dribbble</a>, <a href="http://uk.linkedin.com/in/mattpbailey">LinkedIn</a> and <a href="https://plus.google.com/116498189973260879447?rel=author">Google+</a>.</p>
        <p>&copy; 2015, Matt Bailey</p>
    </div>
</div>

        <div class="wrap">
            <div class="masthead">
    <div class="container">
        <h3 class="masthead-title"><a href="/" title="Home">Matt Bailey</a><br><span class="masthead-title__tagline">Designer &amp; Developer</span></h3>
    </div>
</div>

            <div id="content" class="container content">
                <div class="post">
    <h1 class="post-title">Optimising the Critical Rendering Path, and Loading CSS Asynchronously and Conditionally</h1>
    <p class="post-date">20 June, 2014</p>
    <p><strong><a href="https://gist.github.com/matt-bailey/602b40c77a5d3381ff26" title="Script by Matt Bailey for loading CSS files asynchronously and conditionally">Go straight to the asynchronous and conditional CSS loading script →</a></strong></p>
<h2>Optimising the Critical Rendering Path</h2>
<p>I&#8217;ve recently been looking into frontend optimisation, or as clients like to refer to it, “can you fix our slow site?” - in my defence I mainly work with <a href="http://magento.com/" title="Magento">Magento</a> sites, so this is not a straightforward task.</p>
<p>Ilya Gregorik at Google has done some great work educating others in <a href="http://youtu.be/YV1nKLWoARQ" title="Ilya Gregorik - Optimising the critical rendering path">optimising the critical rendering path</a>, and one of his recommendations is to inline critical CSS in the head and defer the loading of other CSS files until after the initial paint.</p>

<h2>So can you load CSS at the bottom of the page?</h2>
<p>I did some experimenting by loading additional, non-critical CSS files at the bottom of the page. However, this caused a FOUC, a flash of un-styled content (not including things styled by the inlined critical styles in the head of course). I believe this has something to do with &lt;script&gt; tags blocking parallel downloads, i.e. the CSS files have to wait until the Javascript files have downloaded. So they have to go back up in the head&#8230;</p>
<h2>What was Ilya Gregorik&#8217;s advice?</h2>
<p><a href="https://twitter.com/igrigorik/status/473853215348228098" title="Ilya Gregorik - advice on loading CSS files">I tweeted Ilya asking his advice</a> and his response led me to the <a href="https://developers.google.com/speed/docs/insights/OptimizeCSSDelivery" title="Google Developers - Optimising CSS Delivery">Google Developers page on Optimising CSS Delivery</a>.</p>
<p>It contains an example script that enables you to load a CSS file asynchronously, after the <em>"initial painting of the page. Its styles are applied to the page once it finishes loading, without blocking the initial render of the critical content."</em></p>
<h2>Taking the Google CSS loading script a bit further</h2>
<p>This was exactly the kind of thing I was looking for, but I needed to take it a step further. I wanted to be able to detect what page I was on and then load multiple CSS files if necessary - there’s no need to load Product Page styles on the Home Page for example.</p>
<p>Part of the optimisation process I&#8217;ve been working on is the modularisation of CSS - creating &#8216;page type&#8217; or function specific stylesheets rather than lumping everything into one big &#8216;main.css’. Case in point - I did a test on one of my sites and discovered that 85% percent of the selectors in my `main.css` file were unused on the homepage. While I’m not surprised by this, it bugged me that there was so much redundancy.</p>
<p><a href="http://sass-lang.com/" title="Sass CSS">Sass</a> and <a href="http://lesscss.org/" title="Less CSS">Less</a> have modularisation covered from a preprocessor point of view - if you follow a modular, component based Sass codebase for your projects (which I do) it&#8217;s pretty easy to create specific CSS files such as critical.css (which I inline in the head), base.css, category-page.css, product-page.css etc. - but what to do with these new CSS files, especially if the pages are built dynamically on a CMS? How do you load them only when needed?</p>
<p>In a nutshell I modified the script on the Google Developers page, allowing me to pass in page specific classes (in my case the classes the CMS was adding to the body tag), and then filter the loading of CSS files based on that information.</p>
<p><strong>Get your hands on the <a href="https://gist.github.com/matt-bailey/602b40c77a5d3381ff26" title="A simple script by Matt Bailey for loading CSS files asynchronously and conditionally">asynchronous and conditional CSS loading script here →</a></strong></p>
<h2>What about other script loaders?</h2>
<p>But can’t you just use an existing script loader for this, something like <a href="http://yepnopejs.com/" title="YepNope">YepNope</a>? I did think of that and I tried it out. However, I still saw a FOUC. I&#8217;m not sure why - maybe it has to do with me having the YepNope tests at the bottom of the page, which slows the down the processing and hence the loading/rendering of the CSS files?</p>
<p>Google’s script (and my modified version) is vanilla Javascript, meaning it doesn’t have any dependencies such as jQuery. It’s inlined in the head, meaning it’s executed right away, and the CSS files are injected in the head so they’re loaded immediately after the first paint but before the rest of the page has rendered.</p>
<p>I’m still in the early stages of using and testing this script, but at first glance it seems to be effective. Let me know if you try it and how you get on?</p>
<h2>UPDATE</h2>
<p>I was also recently pointed to this <a href="https://github.com/filamentgroup/loadCSS/" title="Scott Yehl - loadCSS">CSS loading script by Scot Yehl</a>.</p>
<p>It is very similar to the Google script (and hence, mine), but it doesn’t seem to have the ability to test for Page Type, or to load multiple files - I may be wrong about that though, I haven’t tried it out.</p>

</div>
<div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_shortname = 'mpkb';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>


            </div>
        </div>
        <label for="sidebar-checkbox" class="sidebar-toggle"></label>
        <script src="/scripts/main.min.js" async></script>
<script src="/scripts/vendor/bind-polyfill.min.js" async></script>
<script src="/scripts/vendor/smooth-scroll.min.js"></script>
<script>
window.smoothScroll.init({
    speed: 1000,
    easing: 'easeInOutQuad',
    updateURL: false,
    offset: 60
});
</script>
<script src="/scripts/vendor/viewport-units-buggyfill.min.js"></script>
<script>window.viewportUnitsBuggyfill.init();</script>
<script>
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-9445744-34']);
_gaq.push(['_trackPageview']);
(function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>

    </body>
</html>
